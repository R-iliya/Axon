# ‚öôÔ∏è Axon Virtual Machine ‚Äî Full Documentation

---

### üß© **Core Structure**

The Axon Virtual Machine (VM) is the **runtime engine** that executes the bytecode generated by the Axon compiler.
It works with a stack-based architecture ‚Äî every instruction manipulates a stack, variables, and frames that represent execution contexts.

* **Frame**

  * A single *execution context* containing:

    * Instruction pointer (`ip`)
    * Code instructions
    * Local variables
    * A stack of values
    * Constants used by the program

  * Example:

    ```python
    Frame(
      code=[("CONST", 0), ("PRINT", None)],
      ip=0,
      stack=[],
      locals={},
      name="main",
      consts=[42]
    )
    ```

* **VM (Virtual Machine)**

  * Manages **frames**, **globals**, and **execution** of Axon bytecode.

  * It executes one instruction at a time until all frames finish.

  * Provides host-side bindings like `print`.

  * Example:

    ```python
    vm = VM()
    vm.push_frame(compiled_code)
    vm.run()
    ```

---

### üßÆ **Instruction Set (Opcodes)**

These are the building blocks of Axon execution.
Each opcode performs a specific operation on the VM‚Äôs **stack**, **locals**, or **globals**.

* **CONST**

  * Pushes a constant value from the constants table.
  * ```
    CONST 0
    ```

    Loads `consts[0]` onto the stack.

* **LOAD_NAME**

  * Retrieves a variable‚Äôs value from `locals` or `globals`.
  * ```
    LOAD_NAME "x"
    ```

    Pushes the current value of `x` onto the stack.

* **STORE_NAME**

  * Pops the top of the stack and stores it in the variable name.
  * ```
    STORE_NAME "y"
    ```

    Assigns the popped value to `y`.

* **BINARY_ADD**

  * Pops two numbers, adds them, and pushes the result.
  * ```
    2 + 3 ‚Üí 5
    ```

* **BINARY_SUB**

  * Pops two numbers, subtracts, and pushes the result.
  * ```
    10 - 4 ‚Üí 6
    ```

* **BINARY_MUL**

  * Pops two numbers, multiplies, and pushes the result.
  * ```
    6 * 7 ‚Üí 42
    ```

* **BINARY_DIV**

  * Pops two numbers, divides, and pushes the result.
  * ```
    8 / 2 ‚Üí 4.0
    ```

* **PRINT**

  * Pops one value and outputs it using the built-in or host `print` binding.
  * ```
    PRINT
    ```

    Displays the top of the stack.

* **RETURN**

  * Ends execution of the current frame and returns to the caller.
  * ```
    RETURN
    ```

* **Unknown Opcode (Error)**

  * If an invalid opcode appears, VM raises:

    ```
    RuntimeError: Unknown opcode XYZ
    ```

---

### üß± **Execution Flow**

The VM uses a **fetch‚Äìdecode‚Äìexecute** loop.
Each iteration runs one instruction, updates the instruction pointer, and moves through the program until all frames are popped.

* **Step-by-step Example**

  * Code:

    ```axon
    let x = 2;
    let y = x * 5;
    print(y);
    ```

  * Compiled Bytecode:

    ```
    CONST 0
    STORE_NAME x
    LOAD_NAME x
    CONST 1
    BINARY_MUL
    STORE_NAME y
    LOAD_NAME y
    PRINT
    RETURN
    ```

  * Stack Trace:

    | Step | Opcode       | Stack | Locals      |
    | ---- | ------------ | ----- | ----------- |
    | 1    | CONST 0      | [2]   | {}          |
    | 2    | STORE_NAME x | []    | {x:2}       |
    | 3    | LOAD_NAME x  | [2]   | {x:2}       |
    | 4    | CONST 1      | [2,5] | {x:2}       |
    | 5    | BINARY_MUL   | [10]  | {x:2}       |
    | 6    | STORE_NAME y | []    | {x:2, y:10} |
    | 7    | LOAD_NAME y  | [10]  | {x:2, y:10} |
    | 8    | PRINT        | []    | {x:2, y:10} |
    | 9    | RETURN       | []    | {x:2, y:10} |

---

### üß≠ **Frame Management**

Frames are how Axon handles scopes, functions, and nested calls.

* **push_frame(co)**

  * Creates and pushes a new frame from a `CodeObject`.

  * Each function call or top-level execution creates a new frame.

  * Example:

    ```python
    vm.push_frame(CodeObject(name="main", ...))
    ```

* **pop_frame()**

  * Removes the current frame from the call stack.
  * Happens automatically when a function or program ends.

* **current()**

  * Returns the currently executing frame.

---

### üåç **Globals & Host Bindings**

The VM includes built-in bindings that connect Axon to host (Python) features.

* **Globals**

  * A shared dictionary for global variables and functions.
  * Example:

    ```python
    self.globals["print"] = self._host_print
    ```

* **_host_print**

  * The built-in `print` handler.
    Used by the `PRINT` opcode.

  * Example:

    ```axon
    print("Hello, Axon!");
    ```

    ‚Üí outputs `Hello, Axon!`

---

### üß© **Error Handling**

The VM throws descriptive runtime errors when things go wrong.

* **Undefined Name**

  * ```
    LOAD_NAME "foo"
    ```

    ‚Üí `RuntimeError: NameError: name 'foo' is not defined`

* **Unknown Opcode**

  * ```
    (XYZ, None)
    ```

    ‚Üí `RuntimeError: Unknown opcode XYZ`

---

### ‚ö° **Example Run**

```python
from axon.vm import VM
from axon.compiler import CodeObject

program = CodeObject(
    name="main",
    code=[
        ("CONST", 0),
        ("STORE_NAME", "x"),
        ("LOAD_NAME", "x"),
        ("CONST", 1),
        ("BINARY_ADD", None),
        ("PRINT", None),
        ("RETURN", None)
    ],
    consts=[10, 20]
)

vm = VM()
vm.push_frame(program)
vm.run()
```

**Output:**

```
30
```

---

### üß† **Concept Summary**

* The **Axon VM** executes compiled bytecode.
* It operates on a **stack-based model**.
* Each execution runs within a **Frame**.
* Instructions manipulate the **stack**, **locals**, and **globals**.
* Errors are Python `RuntimeError`s for simplicity.

---

### üß∞ **Future Additions**

* Conditional opcodes (`JUMP_IF_TRUE`, `JUMP_IF_FALSE`)
* Function calls with arguments
* Return values with `RETURN`
* Built-in math and system functions
* Debugging tools and step tracing

---

### üóÇÔ∏è **File Context**

```
axon/
‚îú‚îÄ‚îÄ lexer.py       # Converts source ‚Üí tokens
‚îú‚îÄ‚îÄ parser.py      # Converts tokens ‚Üí AST
‚îú‚îÄ‚îÄ compiler.py    # Converts AST ‚Üí bytecode
‚îú‚îÄ‚îÄ vm.py          # Executes bytecode ‚Üê this file
‚îî‚îÄ‚îÄ nodes.py       # AST node definitions
```

---

### üßæ **License & Info**

* **Project:** Axon Language
* **Version:** 0.1.0
* **License:** MIT
* **Maintainers:** Axon Project Team

---

